<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DOSSIER — Document Intelligence System</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0b0d;
  --bg-secondary: #111318;
  --bg-tertiary: #181b22;
  --bg-card: #1a1d25;
  --bg-hover: #22262f;
  --border: #2a2e38;
  --border-active: #3d4350;
  --text-primary: #e8eaed;
  --text-secondary: #9aa0ad;
  --text-muted: #5f6572;
  --accent: #c4473a;
  --accent-dim: #8b3229;
  --accent-glow: rgba(196, 71, 58, 0.15);
  --entity-person: #e07c4a;
  --entity-place: #4a9de0;
  --entity-org: #9b6de0;
  --entity-date: #4ae0a8;
  --entity-thing: #e0c94a;
  --category-deposition: #e07c4a;
  --category-flight: #4a9de0;
  --category-correspondence: #9b6de0;
  --category-report: #4ae0a8;
  --category-legal: #e0c94a;
  --category-other: #5f6572;
  --radius: 6px;
  --radius-lg: 10px;
  --font-mono: 'JetBrains Mono', monospace;
  --font-sans: 'DM Sans', sans-serif;
  --transition: 180ms ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-sans);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ─── GRAIN OVERLAY ─── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

/* ─── SCROLLBAR ─── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-active); }

/* ─── LAYOUT ─── */
.app {
  display: grid;
  grid-template-columns: 260px 1fr 320px;
  grid-template-rows: auto 1fr;
  height: 100vh;
}

/* ─── HEADER ─── */
.header {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
}

.header-brand {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-logo {
  width: 32px;
  height: 32px;
  background: var(--accent);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 14px;
  color: #fff;
  letter-spacing: -1px;
}

.header-title {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 15px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-primary);
}

.header-subtitle {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  letter-spacing: 1px;
}

.header-stats {
  display: flex;
  gap: 24px;
  align-items: center;
}

.stat {
  text-align: right;
}

.stat-value {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 18px;
  color: var(--text-primary);
}

.stat-label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-family: var(--font-mono);
}

/* ─── SIDEBAR ─── */
.sidebar {
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: 16px 0;
}

.sidebar-section {
  margin-bottom: 8px;
}

.sidebar-heading {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  padding: 12px 20px 8px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 20px;
  cursor: pointer;
  transition: background var(--transition);
  font-size: 13px;
  color: var(--text-secondary);
}

.sidebar-item:hover { background: var(--bg-hover); }
.sidebar-item.active { background: var(--accent-glow); color: var(--text-primary); }
.sidebar-item.active .sidebar-dot { background: var(--accent); }

.sidebar-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--border-active);
  flex-shrink: 0;
}

.sidebar-count {
  margin-left: auto;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
}

.category-dot { border-radius: 2px; }
.category-dot.deposition { background: var(--category-deposition); }
.category-dot.flight { background: var(--category-flight); }
.category-dot.correspondence { background: var(--category-correspondence); }
.category-dot.report { background: var(--category-report); }
.category-dot.legal { background: var(--category-legal); }
.category-dot.other { background: var(--category-other); }

/* ─── MAIN CONTENT ─── */
.main {
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* ─── SEARCH BAR ─── */
.search-container {
  position: relative;
}

.search-input {
  width: 100%;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 20px 14px 48px;
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--text-primary);
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
}

.search-input::placeholder { color: var(--text-muted); }
.search-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.search-icon {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 16px;
}

.search-filters {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.filter-chip {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 5px 14px;
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filter-chip:hover { border-color: var(--border-active); color: var(--text-primary); }
.filter-chip.active {
  background: var(--accent-glow);
  border-color: var(--accent-dim);
  color: var(--accent);
}

/* ─── RESULTS ─── */
.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.results-title {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

.results-sort {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  background: none;
  border: none;
  cursor: pointer;
}

.document-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.document-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}

.document-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  border-radius: 3px 0 0 3px;
}

.document-card.cat-deposition::before { background: var(--category-deposition); }
.document-card.cat-flight::before { background: var(--category-flight); }
.document-card.cat-correspondence::before { background: var(--category-correspondence); }
.document-card.cat-report::before { background: var(--category-report); }
.document-card.cat-legal::before { background: var(--category-legal); }
.document-card.cat-other::before { background: var(--category-other); }

.document-card:hover {
  border-color: var(--border-active);
  background: var(--bg-hover);
  transform: translateY(-1px);
}

.document-card.selected {
  border-color: var(--accent-dim);
  background: var(--accent-glow);
}

.doc-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.doc-title {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
  line-height: 1.4;
}

.doc-badge {
  font-family: var(--font-mono);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 3px 8px;
  border-radius: 3px;
  white-space: nowrap;
  flex-shrink: 0;
  margin-left: 12px;
}

.doc-badge.deposition { background: rgba(224,124,74,0.15); color: var(--category-deposition); }
.doc-badge.flight { background: rgba(74,157,224,0.15); color: var(--category-flight); }
.doc-badge.correspondence { background: rgba(155,109,224,0.15); color: var(--category-correspondence); }
.doc-badge.report { background: rgba(74,224,168,0.15); color: var(--category-report); }
.doc-badge.legal { background: rgba(224,201,74,0.15); color: var(--category-legal); }

.doc-excerpt {
  font-size: 12.5px;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 10px;
}

.doc-excerpt mark {
  background: rgba(196, 71, 58, 0.25);
  color: var(--accent);
  padding: 1px 3px;
  border-radius: 2px;
}

.doc-meta {
  display: flex;
  gap: 16px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.doc-entities {
  display: flex;
  gap: 6px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.entity-tag {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 3px;
  letter-spacing: 0.3px;
}

.entity-tag.person { background: rgba(224,124,74,0.12); color: var(--entity-person); }
.entity-tag.place { background: rgba(74,157,224,0.12); color: var(--entity-place); }
.entity-tag.org { background: rgba(155,109,224,0.12); color: var(--entity-org); }
.entity-tag.date { background: rgba(74,224,168,0.12); color: var(--entity-date); }

/* ─── RIGHT PANEL ─── */
.panel {
  background: var(--bg-secondary);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.panel-section {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
}

.panel-heading {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.panel-heading .toggle {
  font-size: 10px;
  color: var(--accent);
  cursor: pointer;
  letter-spacing: 0;
  text-transform: none;
  font-weight: 400;
}

/* ─── FREQUENCY BARS ─── */
.freq-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.freq-item {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: opacity var(--transition);
}

.freq-item:hover { opacity: 0.8; }

.freq-rank {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  width: 18px;
  text-align: right;
  flex-shrink: 0;
}

.freq-bar-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.freq-label {
  font-size: 12px;
  color: var(--text-secondary);
}

.freq-bar-track {
  height: 4px;
  background: var(--bg-primary);
  border-radius: 2px;
  overflow: hidden;
}

.freq-bar {
  height: 100%;
  border-radius: 2px;
  transition: width 600ms cubic-bezier(0.22, 1, 0.36, 1);
}

.freq-bar.person { background: var(--entity-person); }
.freq-bar.place { background: var(--entity-place); }
.freq-bar.org { background: var(--entity-org); }
.freq-bar.keyword { background: var(--accent); }

.freq-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  width: 32px;
  text-align: right;
  flex-shrink: 0;
}

/* ─── ENTITY NETWORK MINI ─── */
.network-placeholder {
  height: 180px;
  background: var(--bg-primary);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.network-placeholder canvas {
  position: absolute;
  inset: 0;
}

.network-label {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  z-index: 1;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ─── UPLOAD ZONE ─── */
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  padding: 32px;
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
  background: var(--bg-tertiary);
}

.upload-zone:hover {
  border-color: var(--accent-dim);
  background: var(--accent-glow);
}

.upload-zone.dragover {
  border-color: var(--accent);
  background: var(--accent-glow);
  transform: scale(1.01);
}

.upload-icon {
  font-size: 28px;
  margin-bottom: 10px;
  color: var(--text-muted);
}

.upload-text {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.upload-hint {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
}

/* ─── PROCESSING INDICATOR ─── */
.processing-bar {
  display: none;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 16px;
  gap: 12px;
  align-items: center;
}

.processing-bar.active { display: flex; }

.processing-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.processing-text {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-secondary);
}

.processing-progress {
  flex: 1;
  height: 3px;
  background: var(--bg-primary);
  border-radius: 2px;
  overflow: hidden;
}

.processing-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 300ms ease;
  width: 0%;
}

/* ─── ANIMATIONS ─── */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.document-card { animation: fadeInUp 300ms ease both; }
.document-card:nth-child(1) { animation-delay: 0ms; }
.document-card:nth-child(2) { animation-delay: 50ms; }
.document-card:nth-child(3) { animation-delay: 100ms; }
.document-card:nth-child(4) { animation-delay: 150ms; }
.document-card:nth-child(5) { animation-delay: 200ms; }

/* ─── RESPONSIVE ─── */
@media (max-width: 1100px) {
  .app { grid-template-columns: 1fr; }
  .sidebar, .panel { display: none; }
}

/* ─── EMPTY STATE ─── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state-title {
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 6px;
  letter-spacing: 1px;
}

.empty-state-desc {
  font-size: 12px;
  color: var(--text-muted);
  max-width: 320px;
  line-height: 1.6;
}

/* ─── TABS ─── */
.panel-tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 14px;
}

.panel-tab {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 8px 12px;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--transition);
}

.panel-tab:hover { color: var(--text-secondary); }
.panel-tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
</style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-brand">
      <div class="header-logo">D</div>
      <div>
        <div class="header-title">Dossier</div>
        <div class="header-subtitle">Document Intelligence System</div>
      </div>
    </div>
    <div class="header-stats">
      <div class="stat">
        <div class="stat-value" id="totalDocs">—</div>
        <div class="stat-label">Documents</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalEntities">—</div>
        <div class="stat-label">Entities</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalPages">—</div>
        <div class="stat-label">Pages</div>
      </div>
    </div>
  </header>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-heading">Collections</div>
      <div class="sidebar-item active" data-filter="all">
        <div class="sidebar-dot"></div>
        All Documents
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-filter="recent">
        <div class="sidebar-dot"></div>
        Recently Added
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-filter="flagged">
        <div class="sidebar-dot"></div>
        Flagged
        <span class="sidebar-count">—</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-heading">Categories</div>
      <div class="sidebar-item" data-filter="deposition">
        <div class="sidebar-dot category-dot deposition"></div>
        Depositions
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-filter="flight">
        <div class="sidebar-dot category-dot flight"></div>
        Flight Logs
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-filter="correspondence">
        <div class="sidebar-dot category-dot correspondence"></div>
        Correspondence
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-filter="report">
        <div class="sidebar-dot category-dot report"></div>
        Police / FBI Reports
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-filter="legal">
        <div class="sidebar-dot category-dot legal"></div>
        Legal Filings
        <span class="sidebar-count">—</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-heading">Entity Types</div>
      <div class="sidebar-item" data-entity="person">
        <div class="sidebar-dot" style="background:var(--entity-person)"></div>
        People
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-entity="place">
        <div class="sidebar-dot" style="background:var(--entity-place)"></div>
        Places
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-entity="org">
        <div class="sidebar-dot" style="background:var(--entity-org)"></div>
        Organizations
        <span class="sidebar-count">—</span>
      </div>
      <div class="sidebar-item" data-entity="date">
        <div class="sidebar-dot" style="background:var(--entity-date)"></div>
        Dates
        <span class="sidebar-count">—</span>
      </div>
    </div>

    <div class="sidebar-section" style="padding: 16px 20px;">
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">⬆</div>
        <div class="upload-text">Drop files to ingest</div>
        <div class="upload-hint">PDF, TXT, HTML, DOCX, images</div>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- Search -->
    <div class="search-container">
      <div class="search-icon">⌕</div>
      <input type="text" class="search-input" id="searchInput" placeholder="Search documents, entities, keywords..." autocomplete="off">
      <div class="search-filters">
        <div class="filter-chip active" data-type="all">All</div>
        <div class="filter-chip" data-type="people">People</div>
        <div class="filter-chip" data-type="places">Places</div>
        <div class="filter-chip" data-type="orgs">Organizations</div>
        <div class="filter-chip" data-type="dates">Dates</div>
        <div class="filter-chip" data-type="keywords">Keywords</div>
      </div>
    </div>

    <!-- Processing Bar -->
    <div class="processing-bar" id="processingBar">
      <div class="processing-spinner"></div>
      <div class="processing-text" id="processingText">Processing document...</div>
      <div class="processing-progress">
        <div class="processing-fill" id="processingFill"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="results-header">
      <div class="results-title" id="resultsTitle">Loading...</div>
      <button class="results-sort" id="sortBtn">Sort: Relevance ↓</button>
    </div>

    <div class="document-list" id="documentList"></div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="panel">
    <!-- Top Keywords -->
    <div class="panel-section">
      <div class="panel-heading">
        Top Keywords
        <span class="toggle" id="keywordToggle">View All</span>
      </div>
      <div class="freq-list" id="keywordFreq"></div>
    </div>

    <!-- Top People -->
    <div class="panel-section">
      <div class="panel-heading">
        Most Referenced People
        <span class="toggle">View All</span>
      </div>
      <div class="freq-list" id="peopleFreq"></div>
    </div>

    <!-- Top Places -->
    <div class="panel-section">
      <div class="panel-heading">
        Top Locations
        <span class="toggle">View All</span>
      </div>
      <div class="freq-list" id="placeFreq"></div>
    </div>

    <!-- Connection Graph -->
    <div class="panel-section">
      <div class="panel-heading">Entity Network</div>
      <div class="network-placeholder">
        <canvas id="networkCanvas"></canvas>
        <div class="network-label">Interactive graph — click entity to explore</div>
      </div>
    </div>
  </aside>
</div>

<script>
// ═══════════════════════════════════════════════
// DOSSIER — Document Intelligence System
// Live API integration
// ═══════════════════════════════════════════════

// ─── UTILITY ───

function debounce(fn, ms) {
  let timer;
  return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

async function api(path) {
  const resp = await fetch(path);
  if (!resp.ok) throw new Error(`API ${resp.status}: ${resp.statusText}`);
  return resp.json();
}

// ─── STATE ───

let selectedDocId = null;
let cachedConnections = [];

// ─── RENDER ───

function normalizeDoc(doc) {
  const mapEntities = arr => (arr || []).map(e => typeof e === 'string' ? e : e.name);
  return {
    id: doc.id,
    title: doc.title || doc.filename || 'Untitled',
    category: doc.category || 'other',
    date: doc.date || '',
    pages: doc.pages || 0,
    source: doc.source || '',
    excerpt: doc.excerpt || '',
    entities: {
      people: mapEntities(doc.entities?.people),
      places: mapEntities(doc.entities?.places),
      orgs: mapEntities(doc.entities?.orgs),
      dates: mapEntities(doc.entities?.dates),
    },
  };
}

function renderDocuments(docs) {
  const list = document.getElementById('documentList');
  if (!docs.length) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">⊘</div>
        <div class="empty-state-title">No documents found</div>
        <div class="empty-state-desc">Try adjusting your search or filters, or upload documents to get started</div>
      </div>`;
    document.getElementById('resultsTitle').textContent = 'No documents';
    return;
  }

  const searchTerm = document.getElementById('searchInput').value.trim();

  list.innerHTML = docs.map(raw => {
    const doc = normalizeDoc(raw);
    let excerpt = doc.excerpt;
    if (searchTerm && excerpt) {
      const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
      excerpt = excerpt.replace(regex, '<mark>$1</mark>');
    }

    const allEntities = [
      ...doc.entities.people.map(e => ({ name: e, type: 'person' })),
      ...doc.entities.places.map(e => ({ name: e, type: 'place' })),
      ...doc.entities.orgs.map(e => ({ name: e, type: 'org' })),
    ].slice(0, 6);

    return `
      <div class="document-card cat-${doc.category}${selectedDocId === doc.id ? ' selected' : ''}" data-id="${doc.id}" onclick="selectDocument(${doc.id})">
        <div class="doc-header">
          <div class="doc-title">${doc.title}</div>
          <div class="doc-badge ${doc.category}">${doc.category}</div>
        </div>
        ${excerpt ? `<div class="doc-excerpt">${excerpt}</div>` : ''}
        ${allEntities.length ? `<div class="doc-entities">
          ${allEntities.map(e => `<span class="entity-tag ${e.type}">${e.name}</span>`).join('')}
        </div>` : ''}
        <div class="doc-meta">
          ${doc.date ? `<span>${doc.date}</span>` : ''}
          <span>${doc.pages} pages</span>
          ${doc.source ? `<span>${doc.source}</span>` : ''}
        </div>
      </div>`;
  }).join('');

  document.getElementById('resultsTitle').textContent = `Showing ${docs.length} document${docs.length !== 1 ? 's' : ''}`;
}

function renderFreqList(containerId, data, maxCount) {
  const container = document.getElementById(containerId);
  if (!data.length) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px 0;">No data yet</div>';
    return;
  }
  const max = maxCount || Math.max(...data.map(d => d.count));

  container.innerHTML = data.map((item, i) => `
    <div class="freq-item" onclick="searchFor('${item.word.replace(/'/g, "\\'")}')">
      <div class="freq-rank">${i + 1}</div>
      <div class="freq-bar-container">
        <div class="freq-label">${item.word}</div>
        <div class="freq-bar-track">
          <div class="freq-bar ${item.type}" style="width: ${(item.count / max * 100).toFixed(1)}%"></div>
        </div>
      </div>
      <div class="freq-count">${item.count.toLocaleString()}</div>
    </div>
  `).join('');
}

function searchFor(term) {
  document.getElementById('searchInput').value = term;
  performSearch();
}


// ─── STATS ───

async function loadStats() {
  try {
    const stats = await api('/api/stats');
    document.getElementById('totalDocs').textContent = (stats.documents || 0).toLocaleString();
    document.getElementById('totalEntities').textContent = (stats.entities || 0).toLocaleString();
    document.getElementById('totalPages').textContent = (stats.pages || 0).toLocaleString();

    // Sidebar counts
    const setCount = (sel, val) => { const el = document.querySelector(sel); if (el) el.textContent = val; };
    setCount('[data-filter="all"] .sidebar-count', stats.documents || 0);
    setCount('[data-filter="flagged"] .sidebar-count', stats.flagged || 0);

    if (stats.categories) {
      for (const [cat, count] of Object.entries(stats.categories)) {
        setCount(`[data-filter="${cat}"] .sidebar-count`, count);
      }
    }
    if (stats.entity_types) {
      for (const [type, count] of Object.entries(stats.entity_types)) {
        setCount(`[data-entity="${type}"] .sidebar-count`, count);
      }
    }
  } catch (e) {
    console.error('Failed to load stats:', e);
  }
}


// ─── DOCUMENTS ───

async function loadDocuments(params = {}) {
  try {
    const qs = new URLSearchParams();
    if (params.category) qs.set('category', params.category);
    if (params.flagged) qs.set('flagged', 'true');
    qs.set('limit', params.limit || 50);
    if (params.offset) qs.set('offset', params.offset);

    const data = await api(`/api/documents?${qs}`);
    renderDocuments(data.documents || []);
  } catch (e) {
    console.error('Failed to load documents:', e);
    renderDocuments([]);
  }
}

function applyCurrentFilter() {
  const active = document.querySelector('.sidebar-item.active');
  const filter = active?.dataset.filter;
  const entity = active?.dataset.entity;

  if (entity) {
    loadDocuments();
  } else if (filter === 'all' || !filter) {
    loadDocuments();
  } else if (filter === 'flagged') {
    loadDocuments({ flagged: true });
  } else if (filter === 'recent') {
    loadDocuments({ limit: 8 });
  } else {
    loadDocuments({ category: filter });
  }
}


// ─── SEARCH ───

async function performSearch() {
  const query = document.getElementById('searchInput').value.trim();

  if (!query) {
    applyCurrentFilter();
    return;
  }

  try {
    const qs = new URLSearchParams({ q: query, limit: '50' });

    const chipType = document.querySelector('.filter-chip.active')?.dataset.type;
    if (chipType && chipType !== 'all' && chipType !== 'keywords') {
      const chipMap = { people: 'person', places: 'place', orgs: 'org', dates: 'date' };
      if (chipMap[chipType]) qs.set('entity_type', chipMap[chipType]);
    }

    const data = await api(`/api/search?${qs}`);
    renderDocuments(data.results || []);
  } catch (e) {
    console.error('Search failed:', e);
    renderDocuments([]);
  }
}


// ─── DOCUMENT SELECTION ───

async function selectDocument(id) {
  if (selectedDocId === id) {
    selectedDocId = null;
    document.querySelectorAll('.document-card').forEach(c => c.classList.remove('selected'));
    loadKeywords();
    loadPeople();
    loadPlaces();
    return;
  }

  selectedDocId = id;
  document.querySelectorAll('.document-card').forEach(c => c.classList.remove('selected'));
  const card = document.querySelector(`[data-id="${id}"]`);
  if (card) card.classList.add('selected');

  try {
    const doc = await api(`/api/documents/${id}`);

    if (doc.keywords?.length) {
      const kw = doc.keywords.slice(0, 8).map(k => ({ word: k.word, count: k.count, type: 'keyword' }));
      renderFreqList('keywordFreq', kw);
    }

    const mapEnts = (arr, type) => (arr || []).map(e => ({
      word: typeof e === 'string' ? e : e.name,
      count: typeof e === 'string' ? 1 : (e.count || 1),
      type,
    }));

    const people = mapEnts(doc.entities?.people, 'person');
    if (people.length) renderFreqList('peopleFreq', people.slice(0, 7));

    const places = mapEnts(doc.entities?.places, 'place');
    if (places.length) renderFreqList('placeFreq', places.slice(0, 6));
  } catch (e) {
    console.error('Failed to load document detail:', e);
  }
}


// ─── SIDEBAR FREQUENCY BARS ───

async function loadKeywords() {
  try {
    const data = await api('/api/keywords?limit=8');
    const items = (data.keywords || []).map(k => ({ word: k.word, count: k.total_count, type: 'keyword' }));
    renderFreqList('keywordFreq', items);
  } catch (e) {
    console.error('Failed to load keywords:', e);
    renderFreqList('keywordFreq', []);
  }
}

async function loadPeople() {
  try {
    const data = await api('/api/entities?type=person&limit=7');
    const items = (data.entities || []).map(e => ({ word: e.name, count: e.total_count, type: 'person' }));
    renderFreqList('peopleFreq', items);
  } catch (e) {
    console.error('Failed to load people:', e);
    renderFreqList('peopleFreq', []);
  }
}

async function loadPlaces() {
  try {
    const data = await api('/api/entities?type=place&limit=6');
    const items = (data.entities || []).map(e => ({ word: e.name, count: e.total_count, type: 'place' }));
    renderFreqList('placeFreq', items);
  } catch (e) {
    console.error('Failed to load places:', e);
    renderFreqList('placeFreq', []);
  }
}


// ─── FILTER CHIPS ───

document.querySelectorAll('.filter-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    performSearch();
  });
});


// ─── SIDEBAR NAVIGATION ───

document.querySelectorAll('.sidebar-item[data-filter]').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('searchInput').value = '';

    const filter = item.dataset.filter;
    if (filter === 'all') {
      loadDocuments();
    } else if (filter === 'flagged') {
      loadDocuments({ flagged: true });
    } else if (filter === 'recent') {
      loadDocuments({ limit: 8 });
    } else {
      loadDocuments({ category: filter });
    }
  });
});

document.querySelectorAll('.sidebar-item[data-entity]').forEach(item => {
  item.addEventListener('click', async () => {
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('searchInput').value = '';

    const type = item.dataset.entity;
    try {
      const data = await api(`/api/entities?type=${type}&limit=15`);
      const items = (data.entities || []).map(e => ({ word: e.name, count: e.total_count, type }));
      if (type === 'person') renderFreqList('peopleFreq', items.slice(0, 10));
      else if (type === 'place') renderFreqList('placeFreq', items.slice(0, 10));
      else renderFreqList('keywordFreq', items.slice(0, 10));
    } catch (e) {
      console.error('Failed to load entities:', e);
    }
    loadDocuments();
  });
});


// ─── UPLOAD ZONE ───

const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
  uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  uploadFiles(e.dataTransfer.files);
});

uploadZone.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = '.pdf,.txt,.html,.docx,.png,.jpg,.jpeg';
  input.onchange = () => uploadFiles(input.files);
  input.click();
});

async function uploadFiles(files) {
  if (!files.length) return;

  const bar = document.getElementById('processingBar');
  const text = document.getElementById('processingText');
  const fill = document.getElementById('processingFill');

  bar.classList.add('active');
  let uploaded = 0;
  const total = files.length;

  for (const file of files) {
    text.textContent = `Uploading ${file.name}... (${uploaded + 1}/${total})`;
    fill.style.width = `${((uploaded + 0.5) / total * 100).toFixed(0)}%`;

    try {
      const formData = new FormData();
      formData.append('file', file);
      const resp = await fetch('/api/upload', { method: 'POST', body: formData });
      const data = await resp.json();
      if (data.success) uploaded++;
      else console.warn(`Upload failed for ${file.name}: ${data.message}`);
    } catch (e) {
      console.error(`Upload error for ${file.name}:`, e);
    }
    fill.style.width = `${((uploaded) / total * 100).toFixed(0)}%`;
  }

  text.textContent = uploaded === total
    ? `Complete — ${uploaded} document${uploaded !== 1 ? 's' : ''} ingested`
    : `Done — ${uploaded}/${total} succeeded`;
  fill.style.width = '100%';

  setTimeout(async () => {
    bar.classList.remove('active');
    fill.style.width = '0%';
    await Promise.all([loadStats(), loadDocuments(), loadKeywords(), loadPeople(), loadPlaces(), loadNetwork()]);
  }, 1500);
}


// ─── NETWORK CANVAS ───

const TYPE_COLORS = {
  person: '#e07c4a',
  place: '#4a9de0',
  org: '#9b6de0',
  date: '#4ae0a8',
};

async function loadNetwork() {
  try {
    const data = await api('/api/connections?limit=30');
    cachedConnections = data.connections || [];
  } catch (e) {
    console.error('Failed to load network:', e);
    cachedConnections = [];
  }
  drawNetwork(cachedConnections);
}

function drawNetwork(connections) {
  const canvas = document.getElementById('networkCanvas');
  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;

  const label = canvas.parentElement.querySelector('.network-label');

  if (!connections.length) {
    if (label) label.style.display = '';
    ctx.fillStyle = 'rgba(232,234,237,0.3)';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText('No connections yet', canvas.width / 2, canvas.height / 2);
    return;
  }

  if (label) label.style.display = 'none';

  // Build node map from connections
  const nodeMap = new Map();
  connections.forEach(c => {
    if (!nodeMap.has(c.source_name)) nodeMap.set(c.source_name, { name: c.source_name, type: c.source_type, weight: 0 });
    if (!nodeMap.has(c.target_name)) nodeMap.set(c.target_name, { name: c.target_name, type: c.target_type, weight: 0 });
    nodeMap.get(c.source_name).weight += c.weight;
    nodeMap.get(c.target_name).weight += c.weight;
  });

  const nodes = Array.from(nodeMap.values());
  const maxWeight = Math.max(...nodes.map(n => n.weight));
  const nameToIdx = {};
  nodes.forEach((n, i) => { nameToIdx[n.name] = i; });

  // Initialize random positions
  nodes.forEach(n => { n.x = 0.15 + Math.random() * 0.7; n.y = 0.15 + Math.random() * 0.7; n.vx = 0; n.vy = 0; });

  // Force-directed layout
  for (let iter = 0; iter < 80; iter++) {
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i + 1; j < nodes.length; j++) {
        let dx = nodes[i].x - nodes[j].x;
        let dy = nodes[i].y - nodes[j].y;
        let dist = Math.sqrt(dx * dx + dy * dy) || 0.01;
        let force = 0.002 / (dist * dist);
        nodes[i].vx += dx * force; nodes[i].vy += dy * force;
        nodes[j].vx -= dx * force; nodes[j].vy -= dy * force;
      }
    }
    connections.forEach(c => {
      const si = nameToIdx[c.source_name], ti = nameToIdx[c.target_name];
      if (si === undefined || ti === undefined) return;
      let dx = nodes[ti].x - nodes[si].x, dy = nodes[ti].y - nodes[si].y;
      let force = Math.sqrt(dx * dx + dy * dy) * 0.05;
      nodes[si].vx += dx * force; nodes[si].vy += dy * force;
      nodes[ti].vx -= dx * force; nodes[ti].vy -= dy * force;
    });
    nodes.forEach(n => {
      n.vx += (0.5 - n.x) * 0.01; n.vy += (0.5 - n.y) * 0.01;
      n.x += n.vx; n.y += n.vy;
      n.vx *= 0.6; n.vy *= 0.6;
      n.x = Math.max(0.08, Math.min(0.92, n.x));
      n.y = Math.max(0.08, Math.min(0.92, n.y));
    });
  }

  // Draw edges
  ctx.strokeStyle = 'rgba(196,71,58,0.12)';
  ctx.lineWidth = 1;
  connections.forEach(c => {
    const si = nameToIdx[c.source_name], ti = nameToIdx[c.target_name];
    if (si === undefined || ti === undefined) return;
    ctx.beginPath();
    ctx.moveTo(nodes[si].x * canvas.width, nodes[si].y * canvas.height);
    ctx.lineTo(nodes[ti].x * canvas.width, nodes[ti].y * canvas.height);
    ctx.stroke();
  });

  // Draw nodes
  nodes.forEach(n => {
    const r = 3 + (n.weight / maxWeight) * 6;
    ctx.beginPath();
    ctx.arc(n.x * canvas.width, n.y * canvas.height, r, 0, Math.PI * 2);
    ctx.fillStyle = TYPE_COLORS[n.type] || '#c4473a';
    ctx.fill();

    const lbl = n.name.length > 10 ? n.name.substring(0, 8) + '..' : n.name;
    ctx.fillStyle = 'rgba(232,234,237,0.6)';
    ctx.font = '8px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText(lbl, n.x * canvas.width, n.y * canvas.height + r + 10);
  });
}


// ─── INIT ───

document.getElementById('searchInput').addEventListener('input', debounce(performSearch, 250));

async function init() {
  await Promise.all([loadStats(), loadDocuments(), loadKeywords(), loadPeople(), loadPlaces(), loadNetwork()]);
}

init();
window.addEventListener('resize', () => drawNetwork(cachedConnections));
</script>

</body>
</html>
